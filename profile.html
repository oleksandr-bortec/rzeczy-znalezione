<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil użytkownika - Rzeczy Znalezione</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" type="image/png" href="/icons/icon-192.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#D4213D">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Gov.pl Bar -->
    <div class="govpl">
        <div class="container">
            <a href="https://www.gov.pl" class="govpl__logo" target="_blank" rel="noopener">gov.pl</a>
            <span class="govpl__text" data-i18n="govpl_text">Serwis Rzeczypospolitej Polskiej</span>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-main">
            <div class="container">
                <div class="header-content">
                    <a href="index.html" class="logo">
                        <span class="logo-text">dane.gov.pl</span>
                        <span class="logo-subtitle" data-i18n="open_data">Otwarte Dane</span>
                    </a>
                    <nav class="nav">
                        <a href="index.html" class="nav-link" data-i18n="nav_admin">Panel urzędnika</a>
                        <a href="public.html" class="nav-link" data-i18n="nav_search">Szukaj rzeczy</a>
                        <div class="nav-auth" id="navAuth"></div>
                        <div class="lang-switcher">
                            <button type="button" class="lang-btn active" data-lang="pl">PL</button>
                            <button type="button" class="lang-btn" data-lang="en">EN</button>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-user-circle"></i> <span data-i18n="profile_title">Profil użytkownika</span></h1>
                <p class="lead" data-i18n="profile_subtitle">Zarządzaj swoim profilem i ustawieniami konta</p>
            </div>

            <div class="profile-layout">
                <!-- Sidebar -->
                <aside class="profile-sidebar">
                    <div class="card">
                        <div class="profile-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <h3 id="sidebarName">Ładowanie...</h3>
                        <p id="sidebarEmail" class="text-muted"></p>
                        <span id="sidebarRole" class="badge"></span>

                        <nav class="profile-nav">
                            <button type="button" class="profile-nav-link active" data-tab="info">
                                <i class="fas fa-user"></i> <span data-i18n="personal_info">Informacje</span>
                            </button>
                            <button type="button" class="profile-nav-link" data-tab="security">
                                <i class="fas fa-lock"></i> <span data-i18n="security">Bezpieczeństwo</span>
                            </button>
                            <button type="button" class="profile-nav-link" data-tab="settings">
                                <i class="fas fa-cog"></i> <span data-i18n="settings">Ustawienia</span>
                            </button>
                            <button type="button" class="profile-nav-link" data-tab="activity" id="activityTab" style="display: none;">
                                <i class="fas fa-history"></i> <span data-i18n="activity">Aktywność</span>
                            </button>
                            <a href="admin.html" class="profile-nav-link" id="adminLink" style="display: none;">
                                <i class="fas fa-user-shield"></i> <span data-i18n="admin_panel">Panel administratora</span>
                            </a>
                        </nav>
                    </div>
                </aside>

                <!-- Main Content -->
                <div class="profile-content">
                    <!-- Personal Information Tab -->
                    <div class="profile-tab active" id="tab-info">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-user"></i> <span data-i18n="personal_info">Informacje osobiste</span></h2>
                                <button type="button" class="btn btn-outline" id="editProfileBtn">
                                    <i class="fas fa-edit"></i> <span data-i18n="edit">Edytuj</span>
                                </button>
                            </div>
                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="form-group">
                                        <label for="profileName" class="required" data-i18n="name">Imię i nazwisko</label>
                                        <input type="text" id="profileName" name="name" required disabled>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="profileEmail" class="required" data-i18n="email">Email</label>
                                            <input type="email" id="profileEmail" name="email" required disabled>
                                        </div>

                                        <div class="form-group">
                                            <label for="profilePhone" data-i18n="phone">Telefon</label>
                                            <input type="tel" id="profilePhone" name="phone" disabled>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="profileOrganization" data-i18n="organization">Organizacja</label>
                                        <input type="text" id="profileOrganization" name="organization" disabled>
                                    </div>

                                    <div class="form-group">
                                        <label data-i18n="role">Rola</label>
                                        <input type="text" id="profileRole" disabled>
                                    </div>

                                    <div class="form-group">
                                        <label data-i18n="created">Utworzono</label>
                                        <input type="text" id="profileCreatedAt" disabled>
                                    </div>

                                    <div class="form-actions" id="profileActions" style="display: none;">
                                        <button type="button" class="btn btn-outline" id="cancelEditBtn" data-i18n="cancel">Anuluj</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> <span data-i18n="save_changes">Zapisz zmiany</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div class="profile-tab" id="tab-security">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-lock"></i> <span data-i18n="security">Bezpieczeństwo</span></h2>
                            </div>
                            <div class="card-body">
                                <h3 data-i18n="change_password">Zmiana hasła</h3>
                                <p class="text-muted" data-i18n="change_password_desc">Regularnie zmieniaj hasło, aby zabezpieczyć swoje konto</p>

                                <form id="passwordForm">
                                    <div class="form-group">
                                        <label for="currentPassword" class="required" data-i18n="current_password">Obecne hasło</label>
                                        <input type="password" id="currentPassword" name="currentPassword" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="newPassword" class="required" data-i18n="new_password">Nowe hasło</label>
                                        <input type="password" id="newPassword" name="newPassword" required minlength="8">
                                        <span class="hint" data-i18n="password_min_length">Minimum 8 znaków</span>
                                    </div>

                                    <div class="form-group">
                                        <label for="confirmPassword" class="required" data-i18n="confirm_password_label">Potwierdź nowe hasło</label>
                                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-key"></i> <span data-i18n="change_password">Zmień hasło</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Active Sessions -->
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-laptop"></i> <span data-i18n="active_sessions">Aktywne sesje</span></h2>
                            </div>
                            <div class="card-body">
                                <div id="sessionsList">
                                    <div class="session-item">
                                        <div class="session-info">
                                            <i class="fas fa-desktop"></i>
                                            <div>
                                                <strong data-i18n="current_session">Bieżąca sesja</strong>
                                                <p class="text-muted"><span data-i18n="logged_in">Zalogowano</span>: <span id="currentSessionTime" data-i18n="loading">Ładowanie...</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="profile-tab" id="tab-settings">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-cog"></i> <span data-i18n="settings">Ustawienia</span></h2>
                            </div>
                            <div class="card-body">
                                <form id="settingsForm">
                                    <div class="form-group">
                                        <label for="settingsLanguage" data-i18n="language_interface">Język interfejsu</label>
                                        <select id="settingsLanguage" name="language">
                                            <option value="pl">Polski</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> <span data-i18n="save_settings">Zapisz ustawienia</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="card card-danger">
                            <div class="card-header">
                                <h2><i class="fas fa-exclamation-triangle"></i> <span data-i18n="danger_zone">Strefa niebezpieczna</span></h2>
                            </div>
                            <div class="card-body">
                                <h3 data-i18n="deactivate_account">Dezaktywacja konta</h3>
                                <p class="text-muted" data-i18n="deactivate_desc">Po dezaktywacji konta nie będziesz mógł się zalogować. Skontaktuj się z administratorem aby reaktywować konto.</p>
                                <button type="button" class="btn btn-danger" id="deactivateBtn">
                                    <i class="fas fa-user-slash"></i> <span data-i18n="deactivate_button">Dezaktywuj konto</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Tab (Admin only) -->
                    <div class="profile-tab" id="tab-activity">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-history"></i> Historia aktywności</h2>
                            </div>
                            <div class="card-body">
                                <div id="activityList">
                                    <p class="text-muted">Ładowanie...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Rzeczy Znalezione</h4>
                    <p>Mechanizm do udostępniania danych o rzeczach znalezionych</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Otwarte Dane - Kancelaria Prezesa Rady Ministrów</p>
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="i18n.js?v=2.0.2"></script>
    <script src="api.js?v=2.0.2"></script>
    <script>
        let currentUser = null;
        let isEditing = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!api.isAuthenticated()) {
                window.location.href = 'index.html';
                return;
            }

            await loadUserProfile();
            initializeTabs();
            initializeProfileForm();
            initializePasswordForm();
            initializeSettingsForm();
            updateAuthUI();
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                currentUser = await api.getCurrentUser();

                if (!currentUser) {
                    window.location.href = 'index.html';
                    return;
                }

                // Update sidebar
                document.getElementById('sidebarName').textContent = currentUser.name;
                document.getElementById('sidebarEmail').textContent = currentUser.email;

                const roleSpan = document.getElementById('sidebarRole');
                roleSpan.textContent = getRoleLabel(currentUser.role);
                roleSpan.className = `badge badge-${currentUser.role}`;

                // Update form
                document.getElementById('profileName').value = currentUser.name || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
                document.getElementById('profilePhone').value = currentUser.phone || '';
                document.getElementById('profileOrganization').value = currentUser.organization || '';
                document.getElementById('profileRole').value = getRoleLabel(currentUser.role);
                document.getElementById('profileCreatedAt').value = formatDate(currentUser.created_at);

                // Settings
                document.getElementById('settingsLanguage').value = currentUser.language || 'pl';

                // Show admin link for admins
                if (currentUser.role === 'admin') {
                    document.getElementById('adminLink').style.display = 'flex';
                    document.getElementById('activityTab').style.display = 'flex';
                }

            } catch (error) {
                console.error('Failed to load profile:', error);
                showToast('error', 'Błąd', 'Nie udało się wczytać profilu');
            }
        }

        // Initialize tabs
        function initializeTabs() {
            document.querySelectorAll('.profile-nav-link[data-tab]').forEach(link => {
                link.addEventListener('click', () => {
                    const tab = link.dataset.tab;

                    // Update active state
                    document.querySelectorAll('.profile-nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    // Show tab
                    document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                    document.getElementById(`tab-${tab}`).classList.add('active');
                });
            });
        }

        // Initialize profile form
        function initializeProfileForm() {
            const form = document.getElementById('profileForm');
            const editBtn = document.getElementById('editProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            const actions = document.getElementById('profileActions');

            editBtn.addEventListener('click', () => {
                isEditing = true;
                document.getElementById('profileName').disabled = false;
                document.getElementById('profilePhone').disabled = false;
                document.getElementById('profileOrganization').disabled = false;
                actions.style.display = 'flex';
                editBtn.style.display = 'none';
            });

            cancelBtn.addEventListener('click', () => {
                isEditing = false;
                document.getElementById('profileName').disabled = true;
                document.getElementById('profilePhone').disabled = true;
                document.getElementById('profileOrganization').disabled = true;
                actions.style.display = 'none';
                editBtn.style.display = 'inline-flex';

                // Reset values
                loadUserProfile();
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const data = {
                    name: document.getElementById('profileName').value,
                    phone: document.getElementById('profilePhone').value,
                    organization: document.getElementById('profileOrganization').value
                };

                try {
                    await api.updateProfile(data);
                    showToast('success', 'Sukces', 'Profil został zaktualizowany');

                    isEditing = false;
                    document.getElementById('profileName').disabled = true;
                    document.getElementById('profilePhone').disabled = true;
                    document.getElementById('profileOrganization').disabled = true;
                    actions.style.display = 'none';
                    editBtn.style.display = 'inline-flex';

                    await loadUserProfile();
                } catch (error) {
                    showToast('error', 'Błąd', error.message || 'Nie udało się zaktualizować profilu');
                }
            });
        }

        // Initialize password form
        function initializePasswordForm() {
            document.getElementById('passwordForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    showToast('error', 'Błąd', 'Hasła nie są identyczne');
                    return;
                }

                if (newPassword.length < 8) {
                    showToast('error', 'Błąd', 'Hasło musi mieć minimum 8 znaków');
                    return;
                }

                try {
                    await api.changePassword(currentPassword, newPassword);
                    showToast('success', 'Sukces', 'Hasło zostało zmienione');
                    document.getElementById('passwordForm').reset();
                } catch (error) {
                    showToast('error', 'Błąd', error.message || 'Nie udało się zmienić hasła');
                }
            });
        }

        // Initialize settings form
        function initializeSettingsForm() {
            document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const language = document.getElementById('settingsLanguage').value;

                try {
                    await api.updateProfile({ language });

                    if (typeof i18n !== 'undefined') {
                        i18n.setLanguage(language);
                    }

                    showToast('success', 'Sukces', 'Ustawienia zostały zapisane');
                } catch (error) {
                    showToast('error', 'Błąd', 'Nie udało się zapisać ustawień');
                }
            });
        }

        // Update auth UI
        function updateAuthUI() {
            const navAuth = document.getElementById('navAuth');
            if (!navAuth || !currentUser) return;

            const isAdmin = currentUser.role === 'admin';
            const adminMenuItem = isAdmin ? '<a href="admin.html" id="adminBtn"><i class="fas fa-user-shield"></i> Administrator</a>' : '';

            navAuth.innerHTML = `
                <div class="user-menu">
                    <button type="button" class="user-menu-btn" id="userMenuBtn">
                        <i class="fas fa-user-circle"></i>
                        <span>${currentUser.name || currentUser.email}</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <a href="profile.html"><i class="fas fa-user"></i> Profil</a>
                        ${adminMenuItem}
                        <a href="javascript:void(0)" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Wyloguj</a>
                    </div>
                </div>
            `;

            const userMenuBtn = document.getElementById('userMenuBtn');
            const dropdown = document.getElementById('userMenuDropdown');

            userMenuBtn.addEventListener('click', () => {
                dropdown.classList.toggle('show');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-menu')) {
                    dropdown.classList.remove('show');
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                await api.logout();
                window.location.href = 'index.html';
            });
        }

        // Helper functions
        function getRoleLabel(role) {
            const roles = {
                'admin': 'Administrator',
                'official': 'Urzędnik',
                'user': 'Użytkownik'
            };
            return roles[role] || role;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // Initialize language switcher
        function initializeLanguageSwitcher() {
            const langBtns = document.querySelectorAll('.lang-btn');

            // Set active button based on current language
            const currentLang = typeof i18n !== 'undefined' ? i18n.getCurrentLanguage() : 'pl';
            langBtns.forEach(btn => {
                if (btn.dataset.lang === currentLang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }

                btn.addEventListener('click', () => {
                    const lang = btn.dataset.lang;
                    if (typeof i18n !== 'undefined') {
                        i18n.setLanguage(lang);

                        // Update active state
                        langBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                });
            });

            // Initialize UI with current language on page load
            if (typeof i18n !== 'undefined') {
                i18n.updateUI();
            }
        }

        // Initialize language switcher on load
        document.addEventListener('DOMContentLoaded', initializeLanguageSwitcher);
    </script>

    <!-- Service Worker Update Handler -->
    <script src="sw-update-handler.js"></script>
</body>
</html>
